# 3.2.4 Type Guards –∏ Narrowing

TypeScript —É–º–µ–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—É–∂–∞—Ç—å —Ç–∏–ø –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –≤–Ω—É—Ç—Ä–∏ —É—Å–ª–æ–≤–Ω—ã—Ö –±–ª–æ–∫–æ–≤ ‚Äî —ç—Ç–æ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è **narrowing**. Type Guards ‚Äî —ç—Ç–æ —É—Å–ª–æ–≤–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥–∞—é—Ç TypeScript —Ç–æ—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º –º–µ—Å—Ç–µ –∫–æ–¥–∞, –ø—Ä–µ–≤—Ä–∞—â–∞—è `string | number | null` –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–∏–ø –±–µ–∑ —è–≤–Ω–æ–≥–æ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏—è.

---

## üéØ –ß—Ç–æ —Ç—ã —É–∑–Ω–∞–µ—à—å

- –ß—Ç–æ —Ç–∞–∫–æ–µ Narrowing –∏ –∫–∞–∫ TypeScript –µ–≥–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç
- –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ guards: `typeof`, `instanceof`, `in`
- –ü—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ `null` –∏ `undefined`
- –ö–∞—Å—Ç–æ–º–Ω—ã–µ Type Guard —Ñ—É–Ω–∫—Ü–∏–∏ (`is`-–ø—Ä–µ–¥–∏–∫–∞—Ç—ã)
- Discriminated Unions –¥–ª—è –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π
- Exhaustiveness checking —Å `never`
- Asserting —Ñ—É–Ω–∫—Ü–∏–∏ (`asserts`)
- –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∂–¥—ã–π –≤–∏–¥ guard

---

## üìñ –¢–µ–æ—Ä–∏—è

### –ß—Ç–æ —Ç–∞–∫–æ–µ Narrowing?

TypeScript –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏ **—Å—É–∂–∞–µ—Ç** (narrow) —Ç–∏–ø –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –≤–Ω—É—Ç—Ä–∏ —É—Å–ª–æ–≤–Ω—ã—Ö –±–ª–æ–∫–æ–≤:

```typescript
function printId(id: string | number) {
  if (typeof id === "string") {
    // –ó–¥–µ—Å—å TypeScript –∑–Ω–∞–µ—Ç: id ‚Äî string
    console.log(id.toUpperCase());
  } else {
    // –ó–¥–µ—Å—å TypeScript –∑–Ω–∞–µ—Ç: id ‚Äî number
    console.log(id.toFixed(2));
  }
}
```

---

## 1. `typeof` guard

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∏–º–∏—Ç–∏–≤–Ω—ã–π —Ç–∏–ø: `"string"`, `"number"`, `"boolean"`, `"undefined"`, `"object"`, `"function"`, `"symbol"`, `"bigint"`.

```typescript
function format(value: string | number | boolean): string {
  if (typeof value === "string") {
    return value.trim();
  }
  if (typeof value === "number") {
    return value.toFixed(2);
  }
  return String(value);
}
```

> **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ:** `typeof null === "object"` ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –±–∞–≥ JavaScript!

```typescript
function processValue(value: string | null) {
  if (typeof value === "object") {
    // ‚ùå –°—é–¥–∞ –ø–æ–ø–∞–¥—ë—Ç –∏ null!
  }
  if (value !== null && typeof value === "string") {
    // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
  }
}
```

---

## 2. `instanceof` guard

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–º –∫–ª–∞—Å—Å–∞:

```typescript
class NetworkError extends Error {
  statusCode: number;
  constructor(message: string, statusCode: number) {
    super(message);
    this.statusCode = statusCode;
  }
}

class ValidationError extends Error {
  field: string;
  constructor(message: string, field: string) {
    super(message);
    this.field = field;
  }
}

function handleError(error: unknown): string {
  if (error instanceof NetworkError) {
    return `–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ ${error.statusCode}: ${error.message}`;
  }
  if (error instanceof ValidationError) {
    return `–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–æ–ª—è "${error.field}": ${error.message}`;
  }
  if (error instanceof Error) {
    return `–û—à–∏–±–∫–∞: ${error.message}`;
  }
  return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞";
}
```

---

## 3. `in` guard

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞ –≤ –æ–±—ä–µ–∫—Ç–µ:

```typescript
interface Cat {
  meow(): void;
}

interface Dog {
  bark(): void;
}

function makeSound(animal: Cat | Dog): void {
  if ("meow" in animal) {
    animal.meow(); // TypeScript –∑–Ω–∞–µ—Ç: —ç—Ç–æ Cat
  } else {
    animal.bark(); // TypeScript –∑–Ω–∞–µ—Ç: —ç—Ç–æ Dog
  }
}
```

---

## 4. –ü—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ `null` –∏ `undefined`

### Equality narrowing

```typescript
function processCity(city: string | null | undefined): string {
  if (city == null) {
    // == null –ø–æ–π–º–∞–µ—Ç –∏ null, –∏ undefined
    return "–ú–æ—Å–∫–≤–∞";
  }
  return city.toUpperCase(); // ‚úÖ TypeScript –∑–Ω–∞–µ—Ç: city ‚Äî string
}
```

### Optional chaining –∫–∞–∫ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞

```typescript
function getTemperature(data: WeatherData | null): number {
  return data?.temperature ?? 0;
}
```

---

## 5. –ö–∞—Å—Ç–æ–º–Ω—ã–µ Type Guards (`is`-–ø—Ä–µ–¥–∏–∫–∞—Ç—ã)

–ö–æ–≥–¥–∞ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö guards –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, —Å–æ–∑–¥–∞—é—Ç —Ñ—É–Ω–∫—Ü–∏—é —Å –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–º —Ç–∏–ø–æ–º `value is Type`:

```typescript
interface WeatherData {
  city: string;
  temperature: number;
  humidity: number;
}

interface ErrorData {
  error: string;
  code: number;
}

// –ö–∞—Å—Ç–æ–º–Ω—ã–π type guard
function isWeatherData(value: unknown): value is WeatherData {
  return (
    typeof value === "object" &&
    value !== null &&
    "city" in value &&
    "temperature" in value &&
    typeof (value as WeatherData).temperature === "number"
  );
}

function processApiResponse(response: unknown): string {
  if (isWeatherData(response)) {
    // TypeScript –∑–Ω–∞–µ—Ç: response ‚Äî WeatherData
    return `${response.city}: ${response.temperature}¬∞C`;
  }
  return "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ";
}
```

---

## 6. Discriminated Unions

–ü–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏—è **–≤–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–∞—é—â–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π** —á–µ—Ä–µ–∑ –æ–±—â–∏–π –ª–∏—Ç–µ—Ä–∞–ª—å–Ω—ã–π —Ç–∏–ø-–¥–∏—Å–∫—Ä–∏–º–∏–Ω–∞—Ç–æ—Ä:

```typescript
type IdleState = {
  status: "idle";
};

type LoadingState = {
  status: "loading";
  city: string;
};

type SuccessState = {
  status: "success";
  data: WeatherData;
  city: string;
};

type ErrorState = {
  status: "error";
  message: string;
  code: number;
};

type AppState = IdleState | LoadingState | SuccessState | ErrorState;
```

TypeScript –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ–ª–µ `status` –∫–∞–∫ –¥–∏—Å–∫—Ä–∏–º–∏–Ω–∞—Ç–æ—Ä:

```typescript
function renderState(state: AppState): string {
  switch (state.status) {
    case "idle":
      return "–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ –¥–ª—è –ø–æ–∏—Å–∫–∞";
    case "loading":
      return `–ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–≥–æ–¥—É –¥–ª—è ${state.city}...`;
    case "success":
      return `${state.data.city}: ${state.data.temperature}¬∞C`;
    case "error":
      return `–û—à–∏–±–∫–∞ ${state.code}: ${state.message}`;
  }
}
```

### Exhaustiveness checking —Å `never`

TypeScript –ø–æ–∫–∞–∂–µ—Ç –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã:

```typescript
function assertNever(value: never): never {
  throw new Error(`–ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Å–ª—É—á–∞–π: ${JSON.stringify(value)}`);
}

function renderState(state: AppState): string {
  switch (state.status) {
    case "idle":    return "...";
    case "loading": return "...";
    case "success": return "...";
    case "error":   return "...";
    default:
      return assertNever(state); // ‚ùå –û—à–∏–±–∫–∞, –µ—Å–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å
  }
}
```

---

## 7. Asserting —Ñ—É–Ω–∫—Ü–∏–∏

–§—É–Ω–∫—Ü–∏–∏ —Å `asserts condition` –≤—ã–±—Ä–∞—Å—ã–≤–∞—é—Ç –æ—à–∏–±–∫—É, –µ—Å–ª–∏ —É—Å–ª–æ–≤–∏–µ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ. –ü–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ TypeScript —Å—á–∏—Ç–∞–µ—Ç —É—Å–ª–æ–≤–∏–µ –∏—Å—Ç–∏–Ω–Ω—ã–º:

```typescript
function assertIsString(value: unknown): asserts value is string {
  if (typeof value !== "string") {
    throw new TypeError(`–û–∂–∏–¥–∞–ª–∞—Å—å —Å—Ç—Ä–æ–∫–∞, –ø–æ–ª—É—á–µ–Ω–æ: ${typeof value}`);
  }
}

function assertIsDefined<T>(value: T | null | undefined): asserts value is T {
  if (value == null) {
    throw new Error("–ó–Ω–∞—á–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ");
  }
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
function processCity(city: string | undefined): void {
  assertIsDefined(city);
  // –ü–æ—Å–ª–µ assertIsDefined TypeScript –∑–Ω–∞–µ—Ç: city ‚Äî string
  console.log(city.toUpperCase()); // ‚úÖ –ë–µ–∑ –æ—à–∏–±–∫–∏
}
```

---

## üìä –ö–æ–≥–¥–∞ —á—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

| Guard | –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–≥–¥–∞ |
|---|---|
| `typeof` | –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–º–∏—Ç–∏–≤–æ–≤: string, number, boolean |
| `instanceof` | –ü—Ä–æ–≤–µ—Ä–∫–∞ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –∫–ª–∞—Å—Å–æ–≤ –∏ –æ—à–∏–±–æ–∫ |
| `in` | –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Å–≤–æ–π—Å—Ç–≤–∞ –≤ –æ–±—ä–µ–∫—Ç–µ/–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ |
| `== null` | –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ null –∏ undefined –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ |
| –ö–∞—Å—Ç–æ–º–Ω—ã–π `is` | –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ª–æ–∂–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –∏ –≤–Ω–µ—à–Ω–∏—Ö –¥–∞–Ω–Ω—ã—Ö |
| Discriminated Union | –ú–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–∞—é—â–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π |
| `asserts` | –ñ—ë—Å—Ç–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Å –≤—ã–±—Ä–æ—Å–æ–º –æ—à–∏–±–∫–∏ |

---

## üéØ –ü—Ä–∞–∫—Ç–∏–∫–∞ 3.2.4.1: typeof –∏ instanceof –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

**–ó–∞–¥–∞—á–∞:** –°–æ–∑–¥–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –ø–æ–≥–æ–¥–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –∏–µ—Ä–∞—Ä—Ö–∏–µ–π –∫–ª–∞—Å—Å–æ–≤ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º narrowing.

### –®–∞–≥–∏:

1. –°–æ–∑–¥–∞–π —Ñ–∞–π–ª `src/modules/errors/WeatherErrors.ts`:

   ```typescript
   export class WeatherNotFoundError extends Error {
     readonly city: string;

     constructor(city: string) {
       super(`–ì–æ—Ä–æ–¥ "${city}" –Ω–µ –Ω–∞–π–¥–µ–Ω`);
       this.name = "WeatherNotFoundError";
       this.city = city;
     }
   }

   export class WeatherNetworkError extends Error {
     readonly statusCode: number;
     readonly url: string;

     constructor(statusCode: number, url: string) {
       super(`–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: HTTP ${statusCode}`);
       this.name = "WeatherNetworkError";
       this.statusCode = statusCode;
       this.url = url;
     }
   }

   export class WeatherValidationError extends Error {
     readonly field: string;
     readonly value: unknown;

     constructor(field: string, value: unknown) {
       super(`–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ª—è "${field}": ${value}`);
       this.name = "WeatherValidationError";
       this.field = field;
       this.value = value;
     }
   }
   ```

2. –°–æ–∑–¥–∞–π —Ñ–∞–π–ª `src/modules/errors/errorHandler.ts`:

   ```typescript
   import {
     WeatherNotFoundError,
     WeatherNetworkError,
     WeatherValidationError,
   } from "./WeatherErrors.js";
   import { errorMessages } from "../utils/dictionaries.js";
   import type { AppErrorCode } from "../../types/weather.js";

   export interface HandledError {
     message: string;
     code: AppErrorCode;
     recoverable: boolean;
   }

   // –û–±—Ä–∞–±–æ—Ç–∞–π –∫–∞–∂–¥—ã–π —Ç–∏–ø –æ—à–∏–±–∫–∏ —á–µ—Ä–µ–∑ instanceof
   export function handleWeatherError(error: unknown): HandledError {
     if (error instanceof WeatherNotFoundError) {
       // –í–µ—Ä–Ω–∏ HandledError —Å –∫–æ–¥–æ–º NOT_FOUND, recoverable: true
     }

     if (error instanceof WeatherNetworkError) {
       // –í–µ—Ä–Ω–∏ HandledError —Å –∫–æ–¥–æ–º NETWORK_ERROR –∏–ª–∏ RATE_LIMIT (–µ—Å–ª–∏ 429)
       // recoverable: statusCode >= 500
     }

     if (error instanceof WeatherValidationError) {
       // –í–µ—Ä–Ω–∏ HandledError —Å –∫–æ–¥–æ–º INVALID_CITY, recoverable: true
     }

     if (error instanceof Error) {
       // –í–µ—Ä–Ω–∏ HandledError —Å –∫–æ–¥–æ–º NETWORK_ERROR, recoverable: false
     }

     // –î–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –æ—à–∏–±–æ–∫ ‚Äî NETWORK_ERROR, recoverable: false
   }
   ```

3. –û–±–Ω–æ–≤–∏ `WeatherService.getData()` ‚Äî –±—Ä–æ—Å–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ—à–∏–±–∫–∏:

   ```typescript
   async getData(city: string): Promise<WeatherData> {
     if (!WeatherService.isValidCityName(city)) {
       throw new WeatherValidationError("city", city);
     }
     // ...
     if (response.status === 404) {
       throw new WeatherNotFoundError(city);
     }
     if (!response.ok) {
       throw new WeatherNetworkError(response.status, url);
     }
   }
   ```

4. –°–æ–∑–¥–∞–π —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª `test-errors.ts`:

   ```typescript
   import { handleWeatherError } from "./src/modules/errors/errorHandler";
   import {
     WeatherNotFoundError,
     WeatherNetworkError,
     WeatherValidationError,
   } from "./src/modules/errors/WeatherErrors";

   const errors = [
     new WeatherNotFoundError("–ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π–ì–æ—Ä–æ–¥"),
     new WeatherNetworkError(404, "/weather?q=..."),
     new WeatherNetworkError(429, "/weather?q=..."),
     new WeatherValidationError("city", "123"),
     new Error("Unexpected error"),
     "–°—Ç—Ä–æ–∫–∞ –≤–º–µ—Å—Ç–æ –æ—à–∏–±–∫–∏",
   ];

   errors.forEach((err) => {
     const handled = handleWeatherError(err);
     console.log(`[${handled.code}] ${handled.message} | recoverable: ${handled.recoverable}`);
   });
   ```

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –ö–∞–∂–¥—ã–π –∫–ª–∞—Å—Å –¥–æ–ª–∂–µ–Ω —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å `this.name`
- `handleWeatherError` –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **—Ç–æ–ª—å–∫–æ `instanceof`** –¥–ª—è –ø—Ä–æ–≤–µ—Ä–æ–∫
- 429 (Rate Limit) –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã–¥–µ–ª–µ–Ω –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç –¥—Ä—É–≥–∏—Ö —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫
- –§—É–Ω–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –ø—Ä–∏–Ω–∏–º–∞—Ç—å `unknown` (–Ω–µ `Error`)

<details>
<summary>üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞ 1: –§—É–Ω–∫—Ü–∏—è handleWeatherError</summary>

```typescript
export function handleWeatherError(error: unknown): HandledError {
  if (error instanceof WeatherNotFoundError) {
    return {
      message: errorMessages.NOT_FOUND,
      code: "NOT_FOUND",
      recoverable: true,
    };
  }

  if (error instanceof WeatherNetworkError) {
    const isRateLimit = error.statusCode === 429;
    return {
      message: isRateLimit ? errorMessages.RATE_LIMIT : errorMessages.NETWORK_ERROR,
      code: isRateLimit ? "RATE_LIMIT" : "NETWORK_ERROR",
      recoverable: error.statusCode >= 500,
    };
  }

  if (error instanceof WeatherValidationError) {
    return {
      message: errorMessages.INVALID_CITY,
      code: "INVALID_CITY",
      recoverable: true,
    };
  }

  if (error instanceof Error) {
    return {
      message: error.message,
      code: "NETWORK_ERROR",
      recoverable: false,
    };
  }

  return {
    message: errorMessages.NETWORK_ERROR,
    code: "NETWORK_ERROR",
    recoverable: false,
  };
}
```
</details>

### –ü—Ä–æ–≤–µ—Ä–∫–∞:
```bash
npm run build && node dist/test-errors.js
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
[NOT_FOUND] –ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ... | recoverable: true
[NETWORK_ERROR] –û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç... | recoverable: false
[RATE_LIMIT] –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤... | recoverable: false
[INVALID_CITY] –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ | recoverable: true
[NETWORK_ERROR] Unexpected error | recoverable: false
[NETWORK_ERROR] –û—à–∏–±–∫–∞ —Å–µ—Ç–∏... | recoverable: false
```

---

## üéØ –ü—Ä–∞–∫—Ç–∏–∫–∞ 3.2.4.2: –ö–∞—Å—Ç–æ–º–Ω—ã–µ Type Guards –¥–ª—è API-–¥–∞–Ω–Ω—ã—Ö

**–ó–∞–¥–∞—á–∞:** –°–æ–∑–¥–∞—Ç—å type guard —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –≤–Ω–µ—à–Ω–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –æ—Ç API.

### –®–∞–≥–∏:

1. –°–æ–∑–¥–∞–π —Ñ–∞–π–ª `src/modules/utils/typeGuards.ts`:

   ```typescript
   import type { WeatherData, SearchQuery, AppSettings } from "../../types/weather.js";
   import type { ApiSuccess, ApiError } from "../api/ApiClient.js";

   // Guard –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî –æ–±—ä–µ–∫—Ç (–Ω–µ null, –Ω–µ –º–∞—Å—Å–∏–≤)
   export function isPlainObject(value: unknown): value is Record<string, unknown> {
     // –ü—Ä–æ–≤–µ—Ä—å: typeof === "object", !== null, !Array.isArray
   }

   // Guard –¥–ª—è —Å—ã—Ä–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ OpenWeatherMap API
   export function isRawWeatherResponse(value: unknown): value is {
     name: string;
     main: { temp: number; feels_like: number; humidity: number; pressure: number };
     wind: { speed: number };
     weather: Array<{ description: string; icon: string }>;
     sys: { country: string };
   } {
     // –ü—Ä–æ–≤–µ—Ä—å –Ω–∞–ª–∏—á–∏–µ –∏ —Ç–∏–ø—ã –≤—Å–µ—Ö –Ω—É–∂–Ω—ã—Ö –ø–æ–ª–µ–π
   }

   // Guard –¥–ª—è ApiSuccess
   export function isApiSuccess<T>(
     response: ApiSuccess<T> | ApiError
   ): response is ApiSuccess<T> {
     return response.success === true;
   }

   // Guard –¥–ª—è AppSettings
   export function isValidAppSettings(value: unknown): value is AppSettings {
     // –ü—Ä–æ–≤–µ—Ä—å units ("celsius" | "fahrenheit"), lang (string), cacheTTL (number)
   }
   ```

2. –ò—Å–ø–æ–ª—å–∑—É–π `isRawWeatherResponse` –≤ `WeatherService.getData()`:

   ```typescript
   const raw = response.data;

   if (!isRawWeatherResponse(raw)) {
     throw new Error("–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç API");
   }

   // –¢–µ–ø–µ—Ä—å TypeScript —Ç–æ—á–Ω–æ –∑–Ω–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É raw
   const weatherData: WeatherData = {
     city: raw.name,
     temperature: raw.main.temp,
     // ...
   };
   ```

3. –°–æ–∑–¥–∞–π —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª `test-type-guards.ts`:

   ```typescript
   import {
     isPlainObject,
     isRawWeatherResponse,
     isApiSuccess,
     isValidAppSettings,
   } from "./src/modules/utils/typeGuards";

   // isPlainObject
   console.log("=== isPlainObject ===");
   console.log(isPlainObject({}));           // true
   console.log(isPlainObject(null));         // false
   console.log(isPlainObject([]));           // false
   console.log(isPlainObject("string"));     // false

   // isRawWeatherResponse
   console.log("\n=== isRawWeatherResponse ===");
   const validRaw = {
     name: "Moscow",
     main: { temp: 5, feels_like: 3, humidity: 80, pressure: 1013 },
     wind: { speed: 3.5 },
     weather: [{ description: "–æ–±–ª–∞—á–Ω–æ", icon: "04d" }],
     sys: { country: "RU" },
   };
   console.log(isRawWeatherResponse(validRaw));  // true
   console.log(isRawWeatherResponse({}));         // false
   console.log(isRawWeatherResponse(null));       // false

   // isValidAppSettings
   console.log("\n=== isValidAppSettings ===");
   console.log(isValidAppSettings({ units: "celsius", lang: "ru", cacheTTL: 60000 })); // true
   console.log(isValidAppSettings({ units: "kelvin", lang: "ru", cacheTTL: 60000 })); // false
   console.log(isValidAppSettings({ units: "celsius" }));                               // false
   ```

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- `isRawWeatherResponse` –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–≤–µ—Ä—è—Ç—å **–≤—Å–µ** –ø–æ–ª—è, –≤–∫–ª—é—á–∞—è –≤–ª–æ–∂–µ–Ω–Ω—ã–µ
- `isValidAppSettings` –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–≤–µ—Ä—è—Ç—å –¥–æ–ø—É—Å—Ç–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è `units`
- –í—Å–µ guards –¥–æ–ª–∂–Ω—ã –ø—Ä–∏–Ω–∏–º–∞—Ç—å `unknown` (–Ω–µ `any`)

<details>
<summary>üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞ 1: isPlainObject –∏ isRawWeatherResponse</summary>

```typescript
export function isPlainObject(value: unknown): value is Record<string, unknown> {
  return typeof value === "object" && value !== null && !Array.isArray(value);
}

export function isRawWeatherResponse(value: unknown): value is { /* ... */ } {
  if (!isPlainObject(value)) return false;

  const { main, wind, weather, sys } = value as any;

  return (
    typeof value.name === "string" &&
    isPlainObject(main) &&
    typeof main.temp === "number" &&
    typeof main.feels_like === "number" &&
    typeof main.humidity === "number" &&
    typeof main.pressure === "number" &&
    isPlainObject(wind) &&
    typeof wind.speed === "number" &&
    Array.isArray(weather) &&
    weather.length > 0 &&
    typeof weather[0].description === "string" &&
    typeof weather[0].icon === "string" &&
    isPlainObject(sys) &&
    typeof sys.country === "string"
  );
}
```
</details>

<details>
<summary>üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞ 2: isValidAppSettings</summary>

```typescript
export function isValidAppSettings(value: unknown): value is AppSettings {
  if (!isPlainObject(value)) return false;

  return (
    (value.units === "celsius" || value.units === "fahrenheit") &&
    typeof value.lang === "string" &&
    value.lang.length > 0 &&
    typeof value.cacheTTL === "number" &&
    value.cacheTTL > 0
  );
}
```
</details>

### –ü—Ä–æ–≤–µ—Ä–∫–∞:
```bash
npm run build && node dist/test-type-guards.js
```

---

## üéØ –ü—Ä–∞–∫—Ç–∏–∫–∞ 3.2.4.3: Discriminated Unions –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏–π

**–ó–∞–¥–∞—á–∞:** –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ Discriminated Unions. –ó–∞–º–µ–Ω–∏—Ç—å —Ä–∞–∑—Ä–æ–∑–Ω–µ–Ω–Ω—ã–µ —Ñ–ª–∞–≥–∏ (`isLoading`, `error`, `data`) –Ω–∞ –µ–¥–∏–Ω—ã–π –æ–±—ä–µ–∫—Ç `AppState`.

### –®–∞–≥–∏:

1. –û–±–Ω–æ–≤–∏ `src/types/weather.ts` ‚Äî –¥–æ–±–∞–≤—å Discriminated Union:

   ```typescript
   import type { WeatherData } from "./weather.js";

   export type AppState =
     | { status: "idle" }
     | { status: "loading"; city: string }
     | { status: "success"; data: WeatherData; city: string; fromCache: boolean }
     | { status: "error"; message: string; code: AppErrorCode; recoverable: boolean };
   ```

2. –°–æ–∑–¥–∞–π —Ñ–∞–π–ª `src/modules/ui/stateRenderer.ts`:

   ```typescript
   import type { AppState } from "../../types/weather.js";
   import { WeatherService } from "../services/WeatherService.js";
   import { toWeatherCard, toWeatherDetails } from "../utils/weatherProjections.js";
   import { getWeatherEmoji } from "../utils/dictionaries.js";

   export interface DomElements {
     weatherCard: HTMLDivElement;
     loadingDiv: HTMLDivElement;
     errorDiv: HTMLDivElement;
     cityNameEl: HTMLHeadingElement;
     descriptionEl: HTMLParagraphElement;
     temperatureEl: HTMLDivElement;
     feelsLikeEl: HTMLDivElement;
     humidityEl: HTMLDivElement;
     pressureEl: HTMLDivElement;
     windEl: HTMLDivElement;
     cacheIndicator: HTMLDivElement;
   }

   // –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —á–µ—Ä–µ–∑ switch –ø–æ status
   export function renderState(
     state: AppState,
     elements: DomElements,
     units: "celsius" | "fahrenheit"
   ): void {
     // –°–∫—Ä–æ–π –≤—Å–µ —Å–µ–∫—Ü–∏–∏
     // –ò—Å–ø–æ–ª—å–∑—É–π switch (state.status)
     // case "idle": –ø–æ–∫–∞–∂–∏ placeholder
     // case "loading": –ø–æ–∫–∞–∂–∏ —Å–ø–∏–Ω–Ω–µ—Ä —Å –∏–º–µ–Ω–µ–º –≥–æ—Ä–æ–¥–∞
     // case "success": –ø–æ–∫–∞–∂–∏ –∫–∞—Ä—Ç–æ—á–∫—É –ø–æ–≥–æ–¥—ã
     // case "error": –ø–æ–∫–∞–∂–∏ –æ—à–∏–±–∫—É
   }

   // Exhaustiveness check
   function assertNever(value: never): never {
     throw new Error(`–ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å: ${JSON.stringify(value)}`);
   }
   ```

3. –û–±–Ω–æ–≤–∏ `src/app.ts` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –µ–¥–∏–Ω—ã–π `AppState`:

   ```typescript
   import { renderState } from "./modules/ui/stateRenderer.js";
   import type { AppState } from "./types/weather.js";

   let state: AppState = { status: "idle" };

   function setState(newState: AppState): void {
     state = newState;
     renderState(state, domElements, weatherService.units);
   }

   async function fetchWeather(city?: string): Promise<void> {
     const searchCity = city || cityInput.value.trim();

     if (!WeatherService.isValidCityName(searchCity)) {
       setState({ status: "error", message: "...", code: "INVALID_CITY", recoverable: true });
       return;
     }

     setState({ status: "loading", city: searchCity });

     try {
       const data = await weatherService.getData(searchCity);
       setState({ status: "success", data, city: searchCity, fromCache: false });
     } catch (error) {
       const handled = handleWeatherError(error);
       setState({ status: "error", ...handled });
     }
   }
   ```

4. –°–æ–∑–¥–∞–π —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª `test-states.ts`:

   ```typescript
   import type { AppState } from "./src/types/weather";

   function describeState(state: AppState): string {
     switch (state.status) {
       case "idle":    return "–û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞";
       case "loading": return `–ó–∞–≥—Ä—É–∑–∫–∞: ${state.city}`;
       case "success": return `–£—Å–ø–µ—Ö: ${state.data.city}, ${state.data.temperature}¬∞C`;
       case "error":   return `–û—à–∏–±–∫–∞ [${state.code}]: ${state.message}`;
     }
   }

   const states: AppState[] = [
     { status: "idle" },
     { status: "loading", city: "–ú–æ—Å–∫–≤–∞" },
     {
       status: "success",
       city: "–ú–æ—Å–∫–≤–∞",
       fromCache: false,
       data: {
         city: "–ú–æ—Å–∫–≤–∞", country: "RU", temperature: 5, feelsLike: 3,
         humidity: 80, pressure: 1013, windSpeed: 3.5,
         description: "–æ–±–ª–∞—á–Ω–æ", icon: "04d",
       },
     },
     { status: "error", message: "–ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω", code: "NOT_FOUND", recoverable: true },
   ];

   states.forEach((s) => console.log(describeState(s)));
   ```

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- `AppState` ‚Äî **Discriminated Union** —Å –ø–æ–ª–µ–º `status`
- `renderState` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `switch` —Å exhaustiveness check
- –ü–æ—Å–ª–µ `setState` –≤–µ—Å—å UI **–ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç—Å—è** —á–µ—Ä–µ–∑ `renderState`
- TypeScript –¥–æ–ª–∂–µ–Ω –≤–∏–¥–µ—Ç—å –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å –±–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏

<details>
<summary>üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞ 1: –§—É–Ω–∫—Ü–∏—è renderState</summary>

```typescript
export function renderState(
  state: AppState,
  el: DomElements,
  units: "celsius" | "fahrenheit"
): void {
  el.weatherCard.style.display = "none";
  el.loadingDiv.style.display = "none";
  el.errorDiv.style.display = "none";

  switch (state.status) {
    case "idle":
      break;

    case "loading":
      el.loadingDiv.style.display = "block";
      break;

    case "success": {
      const card = toWeatherCard(state.data);
      const details = toWeatherDetails(state.data);

      el.weatherCard.style.display = "block";
      el.cityNameEl.textContent = `${card.city}, ${state.data.country}`;
      el.descriptionEl.textContent = `${getWeatherEmoji(card.icon)} ${card.description}`;
      el.temperatureEl.textContent = WeatherService.formatTemperature(card.temperature, units);
      el.feelsLikeEl.textContent = WeatherService.formatTemperature(details.feelsLike, units);
      el.humidityEl.textContent = `${details.humidity}%`;
      el.pressureEl.textContent = `${details.pressure} hPa`;
      el.windEl.textContent = `${details.windSpeed} –º/—Å`;
      el.cacheIndicator.style.display = state.fromCache ? "block" : "none";
      break;
    }

    case "error":
      el.errorDiv.textContent = state.message;
      el.errorDiv.style.display = "block";
      break;

    default:
      assertNever(state);
  }
}
```
</details>

<details>
<summary>üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞ 2: setState –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞</summary>

```typescript
// –°–æ–±–µ—Ä–∏ –≤—Å–µ DOM-—ç–ª–µ–º–µ–Ω—Ç—ã –≤ –æ–¥–∏–Ω –æ–±—ä–µ–∫—Ç
const domElements: DomElements = {
  weatherCard: document.getElementById("weather-card") as HTMLDivElement,
  loadingDiv: document.getElementById("loading") as HTMLDivElement,
  errorDiv: document.getElementById("error") as HTMLDivElement,
  cityNameEl: document.getElementById("city-name") as HTMLHeadingElement,
  descriptionEl: document.getElementById("description") as HTMLParagraphElement,
  temperatureEl: document.getElementById("temperature") as HTMLDivElement,
  feelsLikeEl: document.getElementById("feels-like") as HTMLDivElement,
  humidityEl: document.getElementById("humidity") as HTMLDivElement,
  pressureEl: document.getElementById("pressure") as HTMLDivElement,
  windEl: document.getElementById("wind") as HTMLDivElement,
  cacheIndicator: document.getElementById("cache-indicator") as HTMLDivElement,
};

let state: AppState = { status: "idle" };

function setState(newState: AppState): void {
  state = newState;
  renderState(state, domElements, weatherService.units);
}
```
</details>

### –ü—Ä–æ–≤–µ—Ä–∫–∞:
```bash
npm run build && node dist/test-states.js
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
–û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞
–ó–∞–≥—Ä—É–∑–∫–∞: –ú–æ—Å–∫–≤–∞
–£—Å–ø–µ—Ö: –ú–æ—Å–∫–≤–∞, 5¬∞C
–û—à–∏–±–∫–∞ [NOT_FOUND]: –ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω
```

---

## üéØ –ü—Ä–∞–∫—Ç–∏–∫–∞ 3.2.4.4: Asserting —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏

**–ó–∞–¥–∞—á–∞:** –°–æ–∑–¥–∞—Ç—å asserting-—Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å—Ç—Ä–æ–≥–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º.

### –®–∞–≥–∏:

1. –î–æ–±–∞–≤—å –≤ `src/modules/utils/typeGuards.ts` asserting-—Ñ—É–Ω–∫—Ü–∏–∏:

   ```typescript
   // –£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ: –∑–Ω–∞—á–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ (–Ω–µ null –∏ –Ω–µ undefined)
   export function assertIsDefined<T>(
     value: T | null | undefined,
     fieldName: string
   ): asserts value is T {
     // –í—ã–±—Ä–æ—Å—å –æ—à–∏–±–∫—É –µ—Å–ª–∏ value == null
   }

   // –£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ: —Å—Ç—Ä–æ–∫–∞ –Ω–µ –ø—É—Å—Ç–∞—è
   export function assertIsNonEmptyString(
     value: unknown,
     fieldName: string
   ): asserts value is string {
     // –í—ã–±—Ä–æ—Å—å –æ—à–∏–±–∫—É –µ—Å–ª–∏ typeof !== "string" –∏–ª–∏ trim() === ""
   }

   // –£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ: —á–∏—Å–ª–æ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ
   export function assertInRange(
     value: unknown,
     min: number,
     max: number,
     fieldName: string
   ): asserts value is number {
     // –í—ã–±—Ä–æ—Å—å –æ—à–∏–±–∫—É –µ—Å–ª–∏ –Ω–µ —á–∏—Å–ª–æ –∏–ª–∏ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –¥–∏–∞–ø–∞–∑–æ–Ω
   }

   // –£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ: –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ WeatherData
   export function assertIsWeatherData(value: unknown): asserts value is WeatherData {
     assertIsNonEmptyString((value as any)?.city, "city");
     assertInRange((value as any)?.temperature, -100, 100, "temperature");
     assertInRange((value as any)?.humidity, 0, 100, "humidity");
     assertInRange((value as any)?.pressure, 800, 1100, "pressure");
   }
   ```

2. –ò—Å–ø–æ–ª—å–∑—É–π `assertIsWeatherData` –≤ `WeatherService` –ø–æ—Å–ª–µ –º–∞–ø–ø–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞:

   ```typescript
   // –í getData(), –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è weatherData:
   assertIsWeatherData(weatherData);
   // TypeScript —Ç–µ–ø–µ—Ä—å —Ç–æ—á–Ω–æ –∑–Ω–∞–µ—Ç, —á—Ç–æ weatherData –≤–∞–ª–∏–¥–µ–Ω
   this.cache.set(city, weatherData);
   return weatherData;
   ```

3. –°–æ–∑–¥–∞–π —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª `test-asserts.ts`:

   ```typescript
   import {
     assertIsDefined,
     assertIsNonEmptyString,
     assertInRange,
     assertIsWeatherData,
   } from "./src/modules/utils/typeGuards";

   function test(name: string, fn: () => void): void {
     try {
       fn();
       console.log(`‚úÖ ${name}`);
     } catch (e) {
       console.log(`‚ùå ${name}: ${(e as Error).message}`);
     }
   }

   test("assertIsDefined ‚Äî OK",    () => { assertIsDefined("value", "field"); });
   test("assertIsDefined ‚Äî null",   () => { assertIsDefined(null, "field"); });
   test("assertIsDefined ‚Äî undef",  () => { assertIsDefined(undefined, "field"); });

   test("assertIsNonEmptyString ‚Äî OK",    () => { assertIsNonEmptyString("–ú–æ—Å–∫–≤–∞", "city"); });
   test("assertIsNonEmptyString ‚Äî empty", () => { assertIsNonEmptyString("", "city"); });
   test("assertIsNonEmptyString ‚Äî num",   () => { assertIsNonEmptyString(42, "city"); });

   test("assertInRange ‚Äî OK",  () => { assertInRange(5, -100, 100, "temp"); });
   test("assertInRange ‚Äî low", () => { assertInRange(-200, -100, 100, "temp"); });
   test("assertInRange ‚Äî high",() => { assertInRange(200, -100, 100, "temp"); });
   ```

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –í—Å–µ asserting-—Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å `asserts ...`
- –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ TypeScript **—Å—É–∂–∞–µ—Ç** —Ç–∏–ø –±–µ–∑ —è–≤–Ω—ã—Ö `as`
- –°–æ–æ–±—â–µ–Ω–∏—è –æ—à–∏–±–æ–∫ –¥–æ–ª–∂–Ω—ã —Å–æ–¥–µ—Ä–∂–∞—Ç—å **–∏–º—è –ø–æ–ª—è** –∏ **–ø–æ–ª—É—á–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ**

<details>
<summary>üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞: assertIsDefined –∏ assertIsNonEmptyString</summary>

```typescript
export function assertIsDefined<T>(
  value: T | null | undefined,
  fieldName: string
): asserts value is T {
  if (value == null) {
    throw new Error(`–ü–æ–ª–µ "${fieldName}" –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç—ã–º (–ø–æ–ª—É—á–µ–Ω–æ: ${value})`);
  }
}

export function assertIsNonEmptyString(
  value: unknown,
  fieldName: string
): asserts value is string {
  if (typeof value !== "string" || value.trim() === "") {
    throw new Error(
      `–ü–æ–ª–µ "${fieldName}" –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ–ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π (–ø–æ–ª—É—á–µ–Ω–æ: ${JSON.stringify(value)})`
    );
  }
}

export function assertInRange(
  value: unknown,
  min: number,
  max: number,
  fieldName: string
): asserts value is number {
  if (typeof value !== "number" || value < min || value > max) {
    throw new Error(
      `–ü–æ–ª–µ "${fieldName}" –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º –æ—Ç ${min} –¥–æ ${max} (–ø–æ–ª—É—á–µ–Ω–æ: ${value})`
    );
  }
}
```
</details>

### –ü—Ä–æ–≤–µ—Ä–∫–∞:
```bash
npm run build && node dist/test-asserts.js
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ assertIsDefined ‚Äî OK
‚ùå assertIsDefined ‚Äî null: –ü–æ–ª–µ "field" –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç—ã–º...
‚ùå assertIsDefined ‚Äî undef: –ü–æ–ª–µ "field" –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç—ã–º...
‚úÖ assertIsNonEmptyString ‚Äî OK
‚ùå assertIsNonEmptyString ‚Äî empty: –ü–æ–ª–µ "city" –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ–ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π...
‚ùå assertIsNonEmptyString ‚Äî num: –ü–æ–ª–µ "city" –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ–ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π...
‚úÖ assertInRange ‚Äî OK
‚ùå assertInRange ‚Äî low: –ü–æ–ª–µ "temp" –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º –æ—Ç -100 –¥–æ 100...
‚ùå assertInRange ‚Äî high: –ü–æ–ª–µ "temp" –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º –æ—Ç -100 –¥–æ 100...
```

---

## üéØ –ü—Ä–∞–∫—Ç–∏–∫–∞ 3.2.4.5: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

**–ó–∞–¥–∞—á–∞:** –ü–æ–¥–∫–ª—é—á–∏—Ç—å –≤—Å—é —Å–∏—Å—Ç–µ–º—É Type Guards –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é: –∑–∞–º–µ–Ω–∏—Ç—å —Ä–∞–∑—Ä–æ–∑–Ω–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ DOM –Ω–∞ `renderState`, –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ —á–µ—Ä–µ–∑ `handleWeatherError`.

### –®–∞–≥–∏:

1. **–û–±–Ω–æ–≤–∏ `src/app.ts`** ‚Äî –ø–µ—Ä–µ–π–¥–∏ –Ω–∞ –µ–¥–∏–Ω—ã–π `AppState`:

   ```typescript
   // src/app.ts
   import { WeatherService } from "./modules/services/WeatherService.js";
   import { History } from "./modules/utils/History.js";
   import { handleWeatherError } from "./modules/errors/errorHandler.js";
   import { renderState } from "./modules/ui/stateRenderer.js";
   import type { AppState, SearchQuery } from "./types/weather.js";
   import type { DomElements } from "./modules/ui/stateRenderer.js";

   const API_KEY = "—Ç–≤–æ–π-api-–∫–ª—é—á";
   const weatherService = new WeatherService(API_KEY);
   const searchHistory = new History<SearchQuery>(20);

   let state: AppState = { status: "idle" };

   // –°–æ–±–µ—Ä–∏ DOM-—ç–ª–µ–º–µ–Ω—Ç—ã –≤ –æ–±—ä–µ–∫—Ç DomElements
   const domElements: DomElements = { /* ... */ };

   function setState(newState: AppState): void {
     state = newState;
     renderState(state, domElements, weatherService.units);

     // –ï—Å–ª–∏ —É—Å–ø–µ—Ö ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏ –≤ –∏—Å—Ç–æ—Ä–∏—é –∏ –æ–±–Ω–æ–≤–∏ UI –∏—Å—Ç–æ—Ä–∏–∏
   }

   async function fetchWeather(city?: string): Promise<void> {
     const searchCity = city ?? cityInput.value.trim();

     if (!WeatherService.isValidCityName(searchCity)) {
       setState({
         status: "error",
         message: "–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ (–º–∏–Ω–∏–º—É–º 2 –±—É–∫–≤—ã)",
         code: "INVALID_CITY",
         recoverable: true,
       });
       return;
     }

     setState({ status: "loading", city: searchCity });

     try {
       const data = await weatherService.getData(searchCity);
       const fromCache = /* –æ–ø—Ä–µ–¥–µ–ª–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–ø—Ä–æ—Å–∞ */;
       setState({ status: "success", data, city: searchCity, fromCache });
     } catch (error) {
       const handled = handleWeatherError(error);
       setState({ status: "error", ...handled });
     }
   }
   ```

2. **–î–æ–±–∞–≤—å –∫–Ω–æ–ø–∫—É "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å"** –¥–ª—è recoverable –æ—à–∏–±–æ–∫ –≤ `index.html`:

   ```html
   <div class="error" id="error">
     <span id="error-message"></span>
     <button id="retry-btn" style="display:none; margin-top: 10px;">
       –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
     </button>
   </div>
   ```

3. **–û–±–Ω–æ–≤–∏ `renderState`** ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–π –∫–Ω–æ–ø–∫—É "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å" —Ç–æ–ª—å–∫–æ –¥–ª—è recoverable:

   ```typescript
   case "error":
     el.errorDiv.style.display = "block";
     // –ü–æ–∫–∞–∂–∏ el.retryBtn —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ state.recoverable === true
   ```

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –í—Å—ë —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ DOM –∏–¥—ë—Ç **—Ç–æ–ª—å–∫–æ** —á–µ—Ä–µ–∑ `setState` ‚Üí `renderState`
- `handleWeatherError` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ª—é–±—É—é –æ—à–∏–±–∫—É –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `HandledError`
- –ö–Ω–æ–ø–∫–∞ "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å" –≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è recoverable –æ—à–∏–±–æ–∫
- TypeScript –¥–æ–ª–∂–µ–Ω **–ø–æ–¥—Å–∫–∞–∑—ã–≤–∞—Ç—å** –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–ª—è –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–≥–æ `case`

<details>
<summary>üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞ 1: –ü–æ–ª–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ setState</summary>

```typescript
function setState(newState: AppState): void {
  state = newState;
  renderState(state, domElements, weatherService.units);

  if (state.status === "success") {
    const query: SearchQuery = {
      city: state.city,
      timestamp: Date.now(),
      result: state.data,
    };
    searchHistory.push(query);
    updateHistoryUI();
    cityInput.value = state.city;
  }

  updateStats();
}
```
</details>

<details>
<summary>üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞ 2: recoverable –∫–Ω–æ–ø–∫–∞ –≤ renderState</summary>

```typescript
case "error": {
  const retryBtn = document.getElementById("retry-btn") as HTMLButtonElement;
  const errorMsg = document.getElementById("error-message") as HTMLSpanElement;

  el.errorDiv.style.display = "block";
  errorMsg.textContent = state.message;
  retryBtn.style.display = state.recoverable ? "block" : "none";
  break;
}
```
</details>

### –ü—Ä–æ–≤–µ—Ä–∫–∞:

1. –ó–∞–ø—É—Å—Ç–∏ dev-—Å–µ—Ä–≤–µ—Ä:
   ```bash
   npm run dev
   ```

2. –ü—Ä–æ–≤–µ—Ä—å —Ä–∞–±–æ—Ç—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
   - ‚úÖ –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ‚Äî `idle` (–ø—É—Å—Ç–æ–π —ç–∫—Ä–∞–Ω)
   - ‚úÖ –ü—Ä–∏ –ø–æ–∏—Å–∫–µ ‚Äî —Å–æ—Å—Ç–æ—è–Ω–∏–µ `loading` (—Å–ø–∏–Ω–Ω–µ—Ä)
   - ‚úÖ –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è ‚Äî `success` (–∫–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–≥–æ–¥—ã)
   - ‚úÖ –ü—Ä–∏ –æ—à–∏–±–∫–µ 404 ‚Äî `error` —Å –∫–Ω–æ–ø–∫–æ–π "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å"
   - ‚úÖ –ü—Ä–∏ –æ—à–∏–±–∫–µ —Å–µ—Ç–∏ ‚Äî `error` –±–µ–∑ –∫–Ω–æ–ø–∫–∏
   - ‚úÖ TypeScript –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª—è –≤ –∫–∞–∂–¥–æ–º `case`

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç —Ä–∞–∑–¥–µ–ª–∞

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –ø—Ä–∞–∫—Ç–∏–∫ —Ç—ã –¥–æ–ª–∂–µ–Ω —É–º–µ—Ç—å:

- [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `typeof` –¥–ª—è narrowing –ø—Ä–∏–º–∏—Ç–∏–≤–æ–≤
- [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `instanceof` –¥–ª—è narrowing –∫–ª–∞—Å—Å–æ–≤ –∏ –æ—à–∏–±–æ–∫
- [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `in` –¥–ª—è narrowing –æ–±—ä–µ–∫—Ç–æ–≤ –ø–æ —Å–≤–æ–π—Å—Ç–≤—É
- [ ] –ü–∏—Å–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–µ type guard —Ñ—É–Ω–∫—Ü–∏–∏ —Å `is`
- [ ] –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å Discriminated Unions –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏–π
- [ ] –î–æ–±–∞–≤–ª—è—Ç—å exhaustiveness check —á–µ—Ä–µ–∑ `never`
- [ ] –°–æ–∑–¥–∞–≤–∞—Ç—å asserting-—Ñ—É–Ω–∫—Ü–∏–∏ —Å `asserts`
- [ ] –ü—Ä–∏–Ω–∏–º–∞—Ç—å `unknown` –≤–º–µ—Å—Ç–æ `any` –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö –æ—à–∏–±–æ–∫
- [ ] –í—ã–±–∏—Ä–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∏–¥ guard –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏

---

## üîó –†–µ—Å—É—Ä—Å—ã

**–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- [Narrowing](https://www.typescriptlang.org/docs/handbook/2/narrowing.html) ‚Äî –ø–æ–ª–Ω–∞—è –≥–ª–∞–≤–∞ –æ narrowing
- [typeof type guards](https://www.typescriptlang.org/docs/handbook/2/narrowing.html#typeof-type-guards) ‚Äî –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ guards
- [Using type predicates](https://www.typescriptlang.org/docs/handbook/2/narrowing.html#using-type-predicates) ‚Äî –∫–∞—Å—Ç–æ–º–Ω—ã–µ guards

**–°—Ç–∞—Ç—å–∏:**
- [TypeScript Narrowing Explained](https://www.totaltypescript.com/books/total-typescript-essentials/unions-literals-and-narrowing#narrowing) ‚Äî Total TypeScript
- [Discriminated Unions in TypeScript](https://basarat.gitbook.io/typescript/type-system/discriminated-unions) ‚Äî –ø–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞–∑–±–æ—Ä

**–í–∏–¥–µ–æ:**
- [Type Guards –≤ TypeScript ‚Äî –ò–≥–æ—Ä—å –ê–Ω—Ç–æ–Ω–æ–≤](https://www.youtube.com/watch?v=GyO516C_aNA)

---

‚è± **–í—Ä–µ–º—è –Ω–∞ –∏–∑—É—á–µ–Ω–∏–µ**: 3-4 —á–∞—Å–∞

---

**–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Ç–µ–º–∞:** [3.2.3 Utility Types](./3.2.3-Utility-Types.md)

**–°–ª–µ–¥—É—é—â–∞—è —Ç–µ–º–∞:** [3.2.5 Conditional Types](./3.2.5-Conditional-Types.md)

---

> ## üöÄ –£—Å–∫–æ—Ä—è–µ–º –∫–∞—Ä—å–µ—Ä–Ω—ã–π —Ä–æ—Å—Ç –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
>
> **–ú–µ–Ω—Ç–æ—Ä—Å—Ç–≤–æ –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ –¥–ª—è Fullstack-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤**
>
> - 7 –¥–Ω–µ–π –±–µ—Å–ø–ª–∞—Ç–Ω–æ, —á—Ç–æ–±—ã –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å
> - –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –ø–æ –∫–æ–¥—É –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ
> - –ú–∞–∫—Å–∏–º—É–º –ø—Ä–∞–∫—Ç–∏–∫–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á–∞—Ö
>
> [**–ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ –º–µ–Ω—Ç–æ—Ä–∞—Ö, –æ–±—É—á–µ–Ω–∏–∏ –∏ –∫–µ–π—Å–∞—Ö ‚Üí**](https://xmentors.ru/dev)
